#!/bin/bash
#FABIO S. SCHMIDT
#SCRIPT PARA CRIAR NOMES ALTERNATIVOS ZIMBRA ATRAVES DE CONSULTA DE ATRIBUTO EM UMA BASE OPENLDAP
#14/12/15
#BASEADO EM: http://laurobmb.wordpress.com/2012/05/25/backup-and-restore-of-list-of-distribution-server-zimbra/
cont1=0
cont2=0
# RELACAO OBTIDA ATRAVES DO ZMPROV GAA
for i in $(cat /tmp/contas.txt); do
ldapsearch -b "dc=base" -x  -D "cn=admin,dc=base" -h localhost -w SENHA -LLL uid=$i mailAlternateAddress | grep mailAlternateAddress: | awk '{print $2}' > /tmp/relacao_alias.txt
cont1=$((cont1+1))
echo "####### $cont1 $i"
cont2=0
for j in $(cat /tmp/relacao_alias.txt); do
cont2=$((cont2+1))
echo -n "$cont2"
echo $i $j
#GERA O SCRIPT_ALIAS.SH QUE DEVE SER EXECUTADO PARA CRIAR OS NOMES ALTERNATIVOS
echo "/opt/zimbra/bin/zmprov aaa $i $j" >> /tmp/script_alias.sh
done
echo " "
echo " " >> /tmp/relacao_alias.txt
done
